@page "/ibank"
@using System.IO
@using ntics.BankConverter
@inject IJSRuntime JSRuntime
<h1>iBank 2 UA client bank</h1>
<label for="accountNumber">Розрахунковий рахунок:</label>
<input @bind-value="accountNumber" id="accountNumber" title="Не обов'язково, допомагає відфільтрувати інші рахунки."/><br />
<label for="uploadFiles">Виберіть файли</label>
<InputFile id="uploadFiles" multiple OnChange="HandleSelection" />
@if (resultFiles != null)
{
    <div style="display:grid;grid-template-columns:auto auto">
        @foreach (var file in resultFiles)
        {
            string color = file.IsLoading ? "gray" : "white";
            <div>
                @file.FileName
            </div>
            <div style="background-color: @color">
                <a class="button_link" href="@file.FileUrl" download="@file.FileName" @onclick="@(e=>DownloadClick(file))">Завантажити </a>
            </div>
        }
    </div>
}


@code
{
    string accountNumber = "";

    List<ResultConvert> resultFiles = new List<ResultConvert>();

    void DownloadClick(ResultConvert r)
    {
        r.IsLoading = true;
    }


    async Task HandleSelection(IFileListEntry[] files)
    {
        resultFiles.Clear();
        foreach (var f in files)
        {
            var result = new ResultConvert();

            try
            {
                var conv = BankStreamConverter.CreateStreamConverter(EBankType.iBankUA, new DefaultLocalizer());

                string r = await conv.ConvertTo1CFormat(f.Data, accountNumber);
                result.FileName = "kb_to_1c" + f.Name + ".xml";
                result.FileUrl = await JSRuntime.InvokeAsync<string>("getFileUrl", r);

            }
            catch (Exception e)
            {
                result.Error = e.Message;
            }
            resultFiles.Add(result);

        }
    }

}